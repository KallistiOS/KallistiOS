/* KallistiOS ##version##
   examples/dreamcast/raylib/beachbox/src/save.c
   Copyright (C) 2024 Agust√≠n Bellagamba
   Copyright (C) 2024 Cypress
*/

#include <assert.h>
#include <kos.h>
#include <dc/vmufs.h>
#include <stdatomic.h>

#include "audio.h"
#include "config.h"
#include "player.h"
#include "save.h"
#include "timer.h"

/*
    Most of the information in this file and the calc_CRC function was taken from:
    https://mc.pp.se/dc/vms/fileheader.html , credits to Marcus Comstedt

    Colors must be in ARGB4444 format

    The palette consists of 16 16-bit integers, one for each colour in the palette. Each integer consists of four
    four-bit fields:
        0-3 : Alpha (15 is fully opaque, 0 is fully transparent)
        4-7 : Red
        8-11 : Green
        12-15 : Blue
    So a value of 0b1111'0000'1111'0000 would be pure green with no transparency.
*/

static constexpr uint16_t bios_light_blue_  = 0b1111'1011'1101'1111;
static constexpr uint16_t bios_black_       = 0b1111'0000'0000'0000;
static constexpr uint16_t bios_red_         = 0b1111'1100'0001'0001;
static constexpr uint16_t bios_periwinkle_  = 0b1111'1000'1001'1111;
static constexpr uint16_t bios_blue_        = 0b1111'0100'0110'1111;
static constexpr uint16_t bios_sand_        = 0b1111'1100'1010'0101;
static constexpr uint16_t bios_darksand_    = 0b1111'1100'0111'0010;
static constexpr uint16_t bios_white_       = 0b1111'1111'1111'1111;
static constexpr uint16_t bios_purple_      = 0b1110'1010'0001'1010;
static constexpr uint16_t bios_gold_        = 0b1111'1110'1010'0000;
static constexpr uint16_t bios_transparent_ = 0b0000'0000'0000'0000;

static constexpr uint16_t bios_save_palette[16] = {
    bios_light_blue_,  bios_black_,       bios_red_,         bios_periwinkle_,  bios_blue_,        bios_sand_,        bios_darksand_,    bios_transparent_,
    bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_,
};

static constexpr uint16_t bios_eyecatch_palette[16] = {
    bios_purple_,      bios_gold_,        bios_black_,       bios_white_,       bios_red_,         bios_transparent_, bios_transparent_, bios_transparent_,
    bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_, bios_transparent_,
};

// The below array contains the frames of the animation shown in the Dreamcast BIOS.
// Each value is a nybble corresponding to a color index in the palette above.
// For example, 0x01 would be a light blue pixel on the left and a black pixel on the right.

// clang-format off
static constexpr int8_t bios_save_animation[512 * 3] = {
    ///////////////////////////////////   FRAME 1    /////////////////////////////////////////////
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x33, 0x33, 0x31, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x13, 0x33, 0x33,
    0x43, 0x43, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x34, 0x34,
    0x34, 0x44, 0x31, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x13, 0x44, 0x43,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x45, 0x54, 0x51, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x55, 0x45,
    0x55, 0x55, 0x51, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x15, 0x55, 0x55,
    0x55, 0x55, 0x51, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x15, 0x55, 0x55,
    0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55,
    ///////////////////////////////////   FRAME 2    /////////////////////////////////////////////
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x33, 0x33, 0x31, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x13, 0x33, 0x33,
    0x34, 0x34, 0x31, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x13, 0x43, 0x43,
    0x43, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x34, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x14, 0x44, 0x44,
    0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55,
    ///////////////////////////////////   FRAME 3    /////////////////////////////////////////////
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x10, 0x00, 0x00,
    0x33, 0x33, 0x31, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x13, 0x33, 0x33,
    0x43, 0x43, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x34, 0x34,
    0x44, 0x34, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x43, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x22, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x41, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x14, 0x44, 0x44,
    0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44,
    0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44,
    0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55, 0x45, 0x54, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
    0x55, 0x55, 0x55, 0x55, 0x65, 0x55, 0x55, 0x55, 0x55, 0x56, 0x55, 0x55, 0x55, 0x55, 0x55, 0x65
};
// clang-format on

// Converted with Crayon VMU tools by Protofall
static constexpr uint8_t bios_eyecatch_bitmap[2016] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x22, 0x22, 0x21, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x22, 0x21, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x02, 0x23, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x21, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x32, 0x21, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33,
    0x33, 0x33, 0x32, 0x23, 0x33, 0x33, 0x33, 0x21, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x22, 0x22, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x32, 0x22, 0x22, 0x23, 0x33, 0x33, 0x22, 0x21, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x32, 0x22, 0x22, 0x23, 0x33, 0x33, 0x23, 0x22, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x12, 0x22, 0x22, 0x22, 0x00, 0x00, 0x02, 0x23, 0x33, 0x32, 0x22, 0x22, 0x33, 0x33, 0x33, 0x23, 0x32, 0x21, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x02, 0x23, 0x33, 0x33, 0x22, 0x21, 0x11, 0x12, 0x23, 0x33, 0x33, 0x22, 0x23, 0x33, 0x33, 0x33, 0x23, 0x33, 0x20, 0x00, 0x00,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x32, 0x11, 0x22, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x23,
    0x33, 0x32, 0x20, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x23, 0x32, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x23, 0x33, 0x33, 0x22, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x33, 0x33,
    0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x32, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x32, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x23, 0x33, 0x33, 0x33, 0x33, 0x20, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x23, 0x33,
    0x33, 0x32, 0x22, 0x33, 0x33, 0x32, 0x33, 0x33, 0x32, 0x23, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x23, 0x33, 0x33, 0x32, 0x22, 0x23, 0x33, 0x32, 0x33, 0x33, 0x33, 0x32, 0x22, 0x22, 0x22, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x21, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x23, 0x33, 0x33, 0x22, 0x22, 0x23, 0x33, 0x33, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x23, 0x33, 0x33, 0x22, 0x22, 0x23, 0x33, 0x33, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x32, 0x21, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x23, 0x33, 0x33, 0x32, 0x22, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x23, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x22,
    0x33, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x22, 0x32, 0x22, 0x23, 0x33, 0x32, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x02, 0x22, 0x33, 0x33, 0x22, 0x22, 0x22, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x22, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x22, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x33, 0x33, 0x22, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x33, 0x33, 0x20, 0x11, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x33, 0x33, 0x20, 0x11, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x34, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x23, 0x33, 0x32, 0x20, 0x11, 0x11, 0x23, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x23, 0x33, 0x32, 0x00,
    0x11, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32,
    0x23, 0x33, 0x32, 0x00, 0x11, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x22, 0x33, 0x33, 0x32, 0x00, 0x11, 0x12, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x23, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x23, 0x33, 0x33, 0x22, 0x00, 0x11, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x33, 0x33, 0x33, 0x20, 0x00, 0x11, 0x22, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x11, 0x12, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x33, 0x33, 0x32, 0x20, 0x00, 0x11, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x44, 0x33, 0x33, 0x33,
    0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x22, 0x33, 0x33, 0x22, 0x11, 0x11, 0x02, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
    0x34, 0x43, 0x33, 0x33, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x23, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x32, 0x12, 0x33, 0x32, 0x21, 0x11, 0x11, 0x02, 0x33, 0x33, 0x33,
    0x33, 0x33, 0x33, 0x33, 0x33, 0x44, 0x33, 0x33, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x22, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x22, 0x12, 0x22, 0x22, 0x11, 0x11, 0x11,
    0x02, 0x23, 0x33, 0x33, 0x33, 0x43, 0x33, 0x33, 0x33, 0x34, 0x44, 0x33, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x02, 0x23, 0x33, 0x33, 0x33, 0x33, 0x32, 0x21, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x23, 0x33, 0x33, 0x33, 0x44, 0x33, 0x33, 0x33, 0x33, 0x34, 0x43, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x22, 0x33, 0x33, 0x33, 0x33,
    0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x23, 0x33, 0x33, 0x33, 0x34, 0x43, 0x33, 0x33, 0x33, 0x33, 0x44, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x02,
    0x22, 0x23, 0x22, 0x22, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x22, 0x33, 0x33, 0x33, 0x33, 0x44, 0x33, 0x33, 0x33, 0x33, 0x34, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x22, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x02, 0x23, 0x33, 0x33, 0x33, 0x34, 0x43, 0x33, 0x33, 0x33, 0x33, 0x11, 0x11, 0x11, 0x11,
    0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x22, 0x33, 0x33, 0x33, 0x33, 0x34, 0x33, 0x33, 0x33, 0x33
};

static int calc_CRC(const unsigned char *buf, int size) {
    int i, c, n = 0;
    for (i = 0; i < size; i++) {
        n ^= (buf[i] << 8);
        for (c = 0; c < 8; c++)
            if (n & 0x8000) n = (n << 1) ^ 4129;
            else n = (n << 1);
    }
    return n & 0xffff;
}

static save_t       save;
static bbox_timer_t save_popup_timer;
static char         save_popup_text[20];

bool vmu_has_enough_space(maple_device_t *vmu) {
    if (!vmu) return false;
    return vmufs_free_blocks(vmu) * 512 >= sizeof(save);
}

void draw_save_popup(void) {
    if (!save_popup_timer.is_running) return;
    DrawRectangle(SCREEN_WIDTH * 0.7, SCREEN_HEIGHT * 0.85, SCREEN_WIDTH * 0.3, SCREEN_HEIGHT * 0.15, (Color){ 1, 17, 34, 220 });
    DrawText(save_popup_text, SCREEN_WIDTH * 0.7 + SCREEN_WIDTH * 0.3 / 2 - MeasureText(save_popup_text, 22) / 2, SCREEN_HEIGHT * 0.9, 22, RAYWHITE);
}

// This prevents VMU animations from being drawn while a save is in progress
// So that we make sure saving doesn't fail
static atomic_bool save_in_progress_ = false;

bool is_save_in_progress(void) {
    return save_in_progress_;
}

int save_game(void) {
    save_in_progress_ = true;
    snprintf(save_popup_text, sizeof(save_popup_text), "Saving...");
    maple_device_t *vmu = maple_enum_type(0, MAPLE_FUNC_MEMCARD);
    if (!vmu) {
        snprintf(save_popup_text, sizeof(save_popup_text), "No VMU found!");
        save_in_progress_ = false;
        return -1;
    }

    constexpr size_t save_size   = sizeof(save);
    constexpr size_t header_size = sizeof(save.header);

    snprintf(save.header.dc_description, sizeof(save.header.dc_description), "Psyop Studios");
    snprintf(save.header.app_identifier, sizeof(save.header.app_identifier), "Psyop Studios");
    save.header.number_icons          = 3;
    save.header.icon_animation_speed  = 14;
    save.header.graphic_eyecatch_type = 3;
    save.header.crc                   = calc_CRC((unsigned char *)&save, save_size);
    save.header.bytes_after_header    = (int32_t)(save_size - header_size);
    memcpy(save.header.icon_palette, bios_save_palette, sizeof(bios_save_palette));
    memcpy(save.header.icon_bitmaps, bios_save_animation, sizeof(bios_save_animation));
    memcpy(save.header.eyecatch_palette, bios_eyecatch_palette, sizeof(bios_eyecatch_palette));
    memcpy(save.header.eyecatch_bitmap, bios_eyecatch_bitmap, sizeof(bios_eyecatch_bitmap));

    save.music_volume = get_music_volume();
    save.sfx_volume   = get_sfx_volume();

    if (!vmu_has_enough_space(vmu)) {
        snprintf(save_popup_text, sizeof(save_popup_text), "Not enough space!");
        save_in_progress_ = false;
        return 0;
    }

    if (0 == vmufs_write(vmu, "BeachBox", &save, save_size, VMUFS_OVERWRITE)) {
        snprintf(save_popup_text, sizeof(save_popup_text), "Game Saved!");
        save_in_progress_ = false;
        return 1;
    }

    snprintf(save_popup_text, sizeof(save_popup_text), "Failed to save!");
    save_in_progress_ = false;
    return -2; // unknown error
}

static void *save_game_wrapper(void *user_data) {
    save_game();
    return nullptr;
}

void save_game_async(void) {
    start_timer(&save_popup_timer, 2.0f);
    thd_create(1, save_game_wrapper, nullptr);
}

void update_save_game_timer(void) {
    update_timer(&save_popup_timer);
}

// This prevents VMU animations from being drawn while a load is in progress
// So that we make sure loading doesn't fail
static atomic_bool load_in_progress_ = false;

bool is_load_in_progress(void) {
    return load_in_progress_;
}

int load_game(void) {
    load_in_progress_   = true;
    maple_device_t *vmu = maple_enum_type(0, MAPLE_FUNC_MEMCARD);
    if (!vmu) {
        load_in_progress_ = false;
        return -1;
    }
    void *save_buffer = malloc(sizeof(save));

    if (vmufs_read(vmu, "BeachBox", &save_buffer, nullptr) == 0) { // If loading was successful
        memcpy(&save, save_buffer, sizeof(save));
        free(save_buffer);
        load_in_progress_ = false;

        for (int i = 0; i < UPGRADE_COUNT; i++) {
            assert_msg(get_upgrade_level(i) <= get_max_upgrade_level(i), "Invalid upgrade level, save is probably corrupted");
        }

        set_music_volume(save.music_volume);
        set_sfx_volume(save.sfx_volume);

        return 1;
    }

    free(save_buffer);
    load_in_progress_ = false;
    return 0;
}

void new_game(void) {
    memset(&save, 0, sizeof(save));
    save.unlocked_hats.nil = true;
    save.music_volume      = 12;
    save.sfx_volume        = 12;
}

uint16_t get_total_coins(void) {
#ifdef DEBUG_INFINITE_COINS
    return UINT16_MAX;
#endif
    return save.total_coins;
}

void add_coins(int n) {
    const int total_coins = get_total_coins();

    // Check for overflow
    if (total_coins + n > UINT16_MAX) {
        n = UINT16_MAX;
    }

    assert_msg(total_coins + n >= 0, "Tried to spend more coins than available");
    save.total_coins += n;
}

uint16_t get_total_runs(void) {
    return save.total_runs;
}

void increment_total_runs(void) {
    // Check for overflow
    const int total_runs_ = get_total_runs();
    if (total_runs_ + 1 > UINT16_MAX) {
        return;
    }

    save.total_runs++;
}

uint16_t get_high_score(void) {
    return save.high_score;
}

void set_high_score(uint16_t new_high_score) {
    save.high_score = new_high_score;
}

uint8_t get_upgrade_level(player_upgrade_t upgrade) {
    assert_msg(upgrade < UPGRADE_COUNT && upgrade >= 0, "Upgrade passed to get_upgrade_level is out of bounds");

    switch (upgrade) {
        case UPGRADE_SPEED:
            return save.upgrade_levels.speed;
        case UPGRADE_METER:
            return save.upgrade_levels.meter;
        case UPGRADE_TELEPORT_UNLOCK:
            return save.upgrade_levels.teleport_unlocked;
        case UPGRADE_TELEPORT_COOLDOWN:
            return save.upgrade_levels.teleport_cooldown;
        case UPGRADE_TELEPORT_DISTANCE:
            return save.upgrade_levels.teleport_distance;
        case UPGRADE_SLOWDOWN_UNLOCK:
            return save.upgrade_levels.slowdown_unlocked;
        case UPGRADE_SLOWDOWN_DRAIN:
            return save.upgrade_levels.slowdown_drain;
        default:
            break;
    }

    assert_msg(false, "Invalid upgrade passed to get_upgrade_level");
    return -1;
}

uint8_t get_max_upgrade_level(player_upgrade_t upgrade) {
    assert_msg(upgrade < UPGRADE_COUNT && upgrade >= 0, "Upgrade passed to get_max_upgrade_level is out of bounds");

    switch (upgrade) {
        case UPGRADE_SLOWDOWN_UNLOCK:
        case UPGRADE_TELEPORT_UNLOCK:
            return 1;
        default:
            return 5;
    }
}

void increment_upgrade_level(player_upgrade_t upgrade) {
    assert_msg(upgrade < UPGRADE_COUNT && upgrade >= 0, "Invalid upgrade passed to increment_upgrade_level");

    switch (upgrade) {
        case UPGRADE_SPEED:
            save.upgrade_levels.speed++;
            break;
        case UPGRADE_METER:
            save.upgrade_levels.meter++;
            break;
        case UPGRADE_TELEPORT_UNLOCK:
            save.upgrade_levels.teleport_unlocked = true;
            break;
        case UPGRADE_TELEPORT_COOLDOWN:
            save.upgrade_levels.teleport_cooldown++;
            break;
        case UPGRADE_TELEPORT_DISTANCE:
            save.upgrade_levels.teleport_distance++;
            break;
        case UPGRADE_SLOWDOWN_UNLOCK:
            save.upgrade_levels.slowdown_unlocked = true;
            break;
        case UPGRADE_SLOWDOWN_DRAIN:
            save.upgrade_levels.slowdown_drain++;
            break;
        default:
            break;
    }
}

hat_t get_current_hat_type(void) {
    return save.hat_index;
}

void increment_current_hat_index(void) {
    save.hat_index = (save.hat_index + 1) % HAT_COUNT;
}

void decrement_current_hat_index(void) {
    save.hat_index = (save.hat_index - 1 + HAT_COUNT) % HAT_COUNT;
}

bool is_hat_unlocked(hat_t hat) {
    assert_msg(hat < HAT_COUNT && hat >= 0, "Hat passed to is_hat_unlocked is out of bounds");

    switch (hat) {
        case HAT_NIL:
            return save.unlocked_hats.nil;
        case HAT_SLIME_RED:
            return save.unlocked_hats.slime_red;
        case HAT_SLIME_BLUE:
            return save.unlocked_hats.slime_blue;
        case HAT_BOX:
            return save.unlocked_hats.box;
        case HAT_M:
            return save.unlocked_hats.m;
        case HAT_L:
            return save.unlocked_hats.l;
        case HAT_Z:
            return save.unlocked_hats.z;
        case HAT_F:
            return save.unlocked_hats.f;
        case HAT_MUPRH:
            return save.unlocked_hats.muprh;
        case HAT_CROWN:
            return save.unlocked_hats.crown;
        default:
            assert_msg(false, "Invalid hat passed to is_hat_unlocked");
            break;
    }

    return false;
}

void unlock_hat(hat_t hat) {
    assert_msg(hat < HAT_COUNT && hat >= 0, "Hat passed to unlock_hat is out of bounds");

    switch (hat) {
        case HAT_NIL:
            save.unlocked_hats.nil = true;
            break;
        case HAT_SLIME_RED:
            save.unlocked_hats.slime_red = true;
            break;
        case HAT_SLIME_BLUE:
            save.unlocked_hats.slime_blue = true;
            break;
        case HAT_BOX:
            save.unlocked_hats.box = true;
            break;
        case HAT_M:
            save.unlocked_hats.m = true;
            break;
        case HAT_L:
            save.unlocked_hats.l = true;
            break;
        case HAT_Z:
            save.unlocked_hats.z = true;
            break;
        case HAT_F:
            save.unlocked_hats.f = true;
            break;
        case HAT_MUPRH:
            save.unlocked_hats.muprh = true;
            break;
        case HAT_CROWN:
            save.unlocked_hats.crown = true;
            break;
        default:
            assert_msg(false, "Invalid hat passed to unlock_hat");
            break;
    }
}

uint8_t get_player_current_color_index(void) {
    return save.color_index;
}

void increment_player_color_index(void) {
    save.color_index = (save.color_index + 1) % get_player_color_count();
}

void decrement_player_color_index(void) {
    save.color_index = (save.color_index - 1 + get_player_color_count()) % get_player_color_count();
}